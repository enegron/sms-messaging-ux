{% extends "base.html" %}

{% block title %}SMS Dashboard{% endblock %}

{% block body %}
<div class="container">
    <div class="card">
        <h2>Summary <span class="section-subtitle">(Last 24 hours)</span></h2>
        <div id="stats" class="stats-grid">
            <div class="stat-card stat-card-users">
                <div class="stat-value stat-value-users" id="total-users">-</div>
                <div class="stat-label">Active Users</div>
            </div>
            <div class="stat-card stat-card-incoming">
                <div class="stat-value stat-value-incoming" id="incoming-count">-</div>
                <div class="stat-label">Incoming Messages</div>
            </div>
            <div class="stat-card stat-card-outgoing">
                <div class="stat-value stat-value-outgoing" id="outgoing-count">-</div>
                <div class="stat-label">Outgoing Messages</div>
            </div>
            <div class="stat-card stat-card-unknown">
                <div class="stat-value stat-value-unknown" id="unknown-count">-</div>
                <div class="stat-label">Unknown Numbers</div>
            </div>
        </div>
    </div>
    <div class="card">
        <h2>Detailed Recent Activity <span class="section-subtitle">(Last 60 minutes)</span></h2>
        <table id="recent-table">
            <thead>
                <tr>
                    <th>Time</th>
                    <th>Type</th>
                    <th>User</th>
                    <th>Message</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="recent-body">
                <tr><td colspan="5" class="empty-state">Loading...</td></tr>
            </tbody>
        </table>
    </div>
</div>
<script>
    async function loadStats() {
        try {
            const [users, incoming, outgoing] = await Promise.all([
                fetch('/api/users').then(r => r.json()),
                fetch('/api/messages/incoming?limit=1000').then(r => r.json()),
                fetch('/api/messages/outgoing?limit=1000').then(r => r.json())
            ]);

            // Time thresholds
            const now = new Date();
            const last24Hours = new Date(now.getTime() - 24 * 60 * 60 * 1000);
            const last60Minutes = new Date(now.getTime() - 60 * 60 * 1000);

            // Filter messages for last 24 hours (summary stats)
            const incomingLast24h = (incoming.messages || []).filter(m => new Date(m.timestamp) >= last24Hours);
            const outgoingLast24h = (outgoing.messages || []).filter(m => new Date(m.queuedAt) >= last24Hours);

            document.getElementById('total-users').textContent = users.count || 0;
            document.getElementById('incoming-count').textContent = incomingLast24h.length;
            document.getElementById('outgoing-count').textContent = outgoingLast24h.length;
            document.getElementById('unknown-count').textContent =
                incomingLast24h.filter(m => !m.isRegistered).length;

            // Filter messages for last 60 minutes (detailed activity)
            const incomingLast60m = (incoming.messages || []).filter(m => new Date(m.timestamp) >= last60Minutes);
            const outgoingLast60m = (outgoing.messages || []).filter(m => new Date(m.queuedAt) >= last60Minutes);

            // Combine and sort recent messages (last 60 minutes)
            const all = [
                ...incomingLast60m.map(m => ({...m, type: 'incoming'})),
                ...outgoingLast60m.map(m => ({...m, type: 'outgoing', timestamp: m.queuedAt}))
            ].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).slice(0, 20);

            const tbody = document.getElementById('recent-body');
            if (all.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No messages in the last 60 minutes</td></tr>';
            } else {
                tbody.innerHTML = all.map(m => `
                    <tr>
                        <td class="timestamp">${new Date(m.timestamp).toLocaleString()}</td>
                        <td><span class="badge ${m.type === 'incoming' ? 'badge-info' : 'badge-success'}">${m.type}</span></td>
                        <td class="phone">${m.userName || m.maskedPhone}</td>
                        <td class="message-content">${m.messageContent || '(empty)'}</td>
                        <td>${m.type === 'incoming'
                            ? (m.isRegistered ? '<span class="badge badge-success">Registered</span>' : '<span class="badge badge-warning">Unknown</span>')
                            : `<span class="badge ${m.status === 'sent' ? 'badge-success' : 'badge-error'}">${m.status}</span>`
                        }</td>
                    </tr>
                `).join('');
            }
        } catch (e) {
            console.error('Failed to load stats:', e);
        }
    }
    loadStats();
</script>
{% endblock %}

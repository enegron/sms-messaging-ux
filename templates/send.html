{% extends "base.html" %}

{% block title %}Send Message - SMS Dashboard{% endblock %}

{% block body %}
<div class="container">
    <div class="card" style="max-width: 600px;">
        <h2>Send New Message</h2>
        <div id="alert"></div>
        <form id="send-form">
            <div class="form-group">
                <label for="phone">Recipient</label>
                <select id="phone" name="phone" required>
                    <option value="">Loading users...</option>
                </select>
            </div>
            <div class="form-group">
                <label for="message">Message</label>
                <textarea id="message" name="message" placeholder="Enter your message..." required></textarea>
                <div style="text-align: right; font-size: 12px; color: #6b7280; margin-top: 5px;">
                    <span id="char-count">0</span> / 1600 characters
                </div>
            </div>
            <div class="form-group simulation-only" id="simulate-status-group" style="display:none;">
                <label for="simulate-status">Simulate Result</label>
                <select id="simulate-status" name="simulate-status">
                    <option value="sent">Success (sent)</option>
                    <option value="failed">Failure (failed)</option>
                    <option value="queued">Queued</option>
                </select>
                <div style="font-size: 12px; color: #6b7280; margin-top: 5px;">
                    Choose the simulated outcome for this message
                </div>
            </div>
            <button type="submit" class="btn">Send Message</button>
        </form>
    </div>
</div>
<script>
    // Load users for dropdown
    async function loadUsers() {
        try {
            const res = await fetch('/api/users?status=active');
            const data = await res.json();

            const select = document.getElementById('phone');
            if (data.users.length === 0) {
                select.innerHTML = '<option value="">No active users found</option>';
            } else {
                select.innerHTML = '<option value="">Select a user...</option>' +
                    data.users.map(u => `<option value="${u.userId}">${u.name || u.maskedPhone} (${u.maskedPhone})</option>`).join('');
            }
        } catch (e) {
            console.error('Failed to load users:', e);
        }
    }
    loadUsers();

    // Character counter
    document.getElementById('message').addEventListener('input', function() {
        document.getElementById('char-count').textContent = this.value.length;
    });

    // Send form
    document.getElementById('send-form').addEventListener('submit', async function(e) {
        e.preventDefault();

        const phone = document.getElementById('phone').value;
        const message = document.getElementById('message').value;
        const simulateStatus = document.getElementById('simulate-status').value;
        const alertDiv = document.getElementById('alert');

        if (!phone) {
            alertDiv.innerHTML = '<div class="alert alert-error">Please select a recipient</div>';
            return;
        }

        try {
            const body = {
                userId: phone,
                messageContent: message
            };

            // Include simulate status if in simulation mode
            if (window.simulationMode) {
                body.simulateStatus = simulateStatus;
            }

            const res = await fetch('/api/send-message', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(body)
            });

            const data = await res.json();

            if (res.ok) {
                const simNote = data.simulated ? ' (simulated)' : '';
                alertDiv.innerHTML = `<div class="alert alert-success">Message ${data.status}${simNote}!</div>`;
                document.getElementById('message').value = '';
                document.getElementById('char-count').textContent = '0';
            } else {
                alertDiv.innerHTML = `<div class="alert alert-error">${data.message || 'Failed to send message'}</div>`;
            }
        } catch (e) {
            alertDiv.innerHTML = '<div class="alert alert-error">Failed to send message</div>';
            console.error('Failed to send:', e);
        }
    });
</script>
{% endblock %}

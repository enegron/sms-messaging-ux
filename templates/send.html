{% extends "base.html" %}

{% block title %}Send Message - SMS Dashboard{% endblock %}

{% block body %}
<div class="modal-overlay" id="result-modal">
    <div class="modal">
        <h3 id="modal-title">Message Sent</h3>
        <div class="modal-body" id="modal-body"></div>
        <div class="modal-footer">
            <button class="btn" onclick="closeModal()">Close</button>
        </div>
    </div>
</div>

<div class="container">
    <div class="card card-narrow">
        <h2>Send New Message</h2>
        <form id="send-form">
            <div class="form-group">
                <label for="phone">Recipient</label>
                <select id="phone" name="phone" required>
                    <option value="">Loading users...</option>
                </select>
            </div>
            <div class="form-group">
                <label for="message">Message</label>
                <textarea id="message" name="message" placeholder="Enter your message..." required></textarea>
                <div class="char-counter">
                    <span id="char-count">0</span> / 1600 characters
                </div>
            </div>
            <div class="form-group simulation-only hidden" id="simulate-status-group">
                <label for="simulate-status">Simulate Result</label>
                <select id="simulate-status" name="simulate-status">
                    <option value="sent">Success (sent)</option>
                    <option value="failed">Failure (failed)</option>
                    <option value="queued">Queued</option>
                </select>
                <div class="form-hint">
                    Choose the simulated outcome for this message
                </div>
            </div>
            <button type="submit" class="btn">Send Message</button>
        </form>
    </div>
</div>
<script>
    // Load users for dropdown
    async function loadUsers() {
        try {
            const res = await fetch('/api/users?status=active');
            const data = await res.json();

            const select = document.getElementById('phone');
            if (data.users.length === 0) {
                select.innerHTML = '<option value="">No active users found</option>';
            } else {
                select.innerHTML = '<option value="">Select a user...</option>' +
                    data.users.map(u => `<option value="${u.userId}">${u.name || u.maskedPhone} (${u.maskedPhone})</option>`).join('');
            }
        } catch (e) {
            console.error('Failed to load users:', e);
        }
    }
    loadUsers();

    // Character counter
    document.getElementById('message').addEventListener('input', function() {
        document.getElementById('char-count').textContent = this.value.length;
    });

    // Modal functions
    function showModal(title, body) {
        document.getElementById('modal-title').textContent = title;
        document.getElementById('modal-body').innerHTML = body;
        document.getElementById('result-modal').classList.add('active');
    }

    function closeModal() {
        document.getElementById('result-modal').classList.remove('active');
        resetForm();
    }

    function resetForm() {
        document.getElementById('phone').selectedIndex = 0;
        document.getElementById('message').value = '';
        document.getElementById('char-count').textContent = '0';
        document.getElementById('simulate-status').selectedIndex = 0;
    }

    // Close modal on overlay click
    document.getElementById('result-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeModal();
        }
    });

    // Send form
    document.getElementById('send-form').addEventListener('submit', async function(e) {
        e.preventDefault();

        const phoneSelect = document.getElementById('phone');
        const phone = phoneSelect.value;
        const recipientName = phoneSelect.options[phoneSelect.selectedIndex].text;
        const message = document.getElementById('message').value;
        const simulateStatus = document.getElementById('simulate-status').value;

        if (!phone) {
            showModal('Error', '<p><span class="label">Please select a recipient before sending.</span></p>');
            return;
        }

        try {
            const body = {
                userId: phone,
                messageContent: message
            };

            // Include simulate status if in simulation mode
            if (window.simulationMode) {
                body.simulateStatus = simulateStatus;
            }

            const res = await fetch('/api/send-message', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(body)
            });

            const data = await res.json();

            if (res.ok) {
                const simNote = data.simulated ? ' (simulated)' : '';
                const statusBadge = data.status === 'sent'
                    ? '<span class="badge badge-success">Sent</span>'
                    : data.status === 'failed'
                    ? '<span class="badge badge-error">Failed</span>'
                    : `<span class="badge badge-info">${data.status}</span>`;

                showModal('Message Result', `
                    <p><span class="label">Recipient:</span> <span class="value">${recipientName}</span></p>
                    <p><span class="label">Status:</span> ${statusBadge}${simNote}</p>
                    <p><span class="label">Message:</span></p>
                    <div class="message-preview">${message}</div>
                `);
            } else {
                showModal('Send Failed', `
                    <p><span class="label">Recipient:</span> <span class="value">${recipientName}</span></p>
                    <p><span class="label">Status:</span> <span class="badge badge-error">Error</span></p>
                    <p><span class="label">Error:</span> <span class="value">${data.message || 'Failed to send message'}</span></p>
                    <p><span class="label">Message:</span></p>
                    <div class="message-preview">${message}</div>
                `);
            }
        } catch (e) {
            showModal('Send Failed', `
                <p><span class="label">Recipient:</span> <span class="value">${recipientName}</span></p>
                <p><span class="label">Status:</span> <span class="badge badge-error">Error</span></p>
                <p><span class="label">Error:</span> <span class="value">Network error - Failed to send message</span></p>
            `);
            console.error('Failed to send:', e);
        }
    });
</script>
{% endblock %}
